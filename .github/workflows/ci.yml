name: Continuous Integration

on:
  push:
    branches: [ main, 5.4 ]
  pull_request:
    branches: [ main, 5.4 ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust: [stable, beta]
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: ${{ matrix.rust }}
          override: true
      
      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run Core Tests
        run: cargo test --package aureon-core --lib
      
      - name: Run Node Tests
        run: cargo test --package aureon-node --lib
      
      - name: Run CLI Tests
        run: cargo test --package aureon-cli --lib
      
      - name: Run All Tests with Output
        run: cargo test --all -- --nocapture
      
      - name: Generate Test Report
        run: cargo test --all -- --nocapture 2>&1 | tee test-report.txt
      
      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-report-${{ matrix.rust }}
          path: test-report.txt

  test-modules:
    name: Test Specific Modules
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      
      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-modules-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Test Consensus Module
        run: cargo test consensus -- --nocapture
      
      - name: Test Smart Contracts Module
        run: cargo test wasm -- --nocapture
      
      - name: Test State Management Module
        run: cargo test mpt -- --nocapture
      
      - name: Test Networking Module
        run: cargo test network -- --nocapture
      
      - name: Test Light Client (SPV)
        run: cargo test spv_client -- --nocapture
      
      - name: Test Production Hardening
        run: cargo test error_recovery -- --nocapture
      
      - name: Test Performance
        run: cargo test performance -- --nocapture
      
      - name: Test Stress Testing
        run: cargo test stress_testing -- --nocapture
      
      - name: Test Security Audit
        run: cargo test cryptography -- --nocapture
      
      - name: Test Access Control
        run: cargo test access_control -- --nocapture
      
      - name: Test Community Governance
        run: cargo test community_governance -- --nocapture
      
      - name: Test Incentive Programs
        run: cargo test incentive_programs -- --nocapture
      
      - name: Test Mainnet Deployment
        run: cargo test mainnet_deployment -- --nocapture
      
      - name: Test Testnet Coordination
        run: cargo test testnet_coordination -- --nocapture

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          components: rustfmt, clippy
      
      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-quality-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Check Format
        run: cargo fmt -- --check
      
      - name: Run Clippy
        run: cargo clippy --all --all-targets -- -D warnings
      
      - name: Check Documentation
        run: cargo doc --no-deps --document-private-items

  build:
    name: Build Release
    runs-on: ubuntu-latest
    needs: [test, test-modules, code-quality]
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      
      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-release-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build Release Binary
        run: cargo build --release --all
      
      - name: Create Release Artifact
        run: |
          mkdir -p release-artifacts
          cp target/release/aureon-node release-artifacts/
          cp target/release/aureon-cli release-artifacts/
      
      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: release-binaries
          path: release-artifacts/

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      
      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin
      
      - name: Generate coverage
        run: cargo tarpaulin --out Xml --all --timeout 300
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./cobertura.xml
          fail_ci_if_error: false

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      
      - name: Install cargo-audit
        run: cargo install cargo-audit
      
      - name: Run Security Audit
        run: cargo audit
        continue-on-error: true

  notify:
    name: Notify on Completion
    runs-on: ubuntu-latest
    needs: [test, test-modules, code-quality, build]
    if: always()
    steps:
      - name: Check Build Status
        run: |
          if [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.test-modules.result }}" == "success" ] && \
             [ "${{ needs.code-quality.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ]; then
            echo "Pipeline Status: ALL CHECKS PASSED"
            exit 0
          else
            echo "Pipeline Status: SOME CHECKS FAILED"
            exit 1
          fi
